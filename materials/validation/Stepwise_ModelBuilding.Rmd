---
title: "Stepwise model building"
author: "Michael Crawford"
date: "2/9/2020"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(tidyverse)
library(ggthemes)
library(gganimate)
library(viridis)
library(ggeffects)
library(lme4)

```


```{r load-data, echo=FALSE, message=FALSE, warning=FALSE}

# Load all the model results
setwd("/Users/Theodore/Documents/Dropbox/Work/Projects/SimNet/Modelling_Experiment/scripts/SimNet_BayesianAnalysis")

data <- readRDS(file = "brms_models.rds") %>%
    filter(Model == "adam")

adam <- data %>% 
    filter(measure == "Shannon") %>%
    select(data) %>%
    unnest()

setwd("~/Desktop")

```


```{r first-view, echo=TRUE}

adam

ggplot(adam) +
    geom_point(aes(x = Shannon,
                   y = total.biomass,
                   color = as.factor(Ninitial))) +
    facet_grid(. ~ Stage) +
    labs(x = "Shannon diveristy",
         y = "Total biomass",
         color = "Richness\ntreatment") +
    scale_color_viridis(discrete = TRUE) +
    theme_few() +
    theme(aspect.ratio = 1)

```

***

# Very simple linear model

First, a very simple linear model that only uses the assembly stage.

```{r simple-linear-model, echo=TRUE, message=FALSE}

d <- adam %>% filter(Stage == "assembly")

model <- lm(data = d, formula = total.biomass ~ Shannon)

summary(model)

t <- ggpredict(model, c("Shannon"))

ggplot(t, 
       aes(x = x,
           y = predicted)) +
    geom_line() +
    labs(x = "Shannon",
         y = "Predicted total biomass") +
    theme_bw()

```

# Slightly more complex model

Continuing to only use the assembly stage, I'm now putting in Ninitial as an explanatory variable.

```{r Ninitial-linear-model, echo=TRUE, message=FALSE}

d <- adam %>% filter(Stage == "assembly")

model <- lm(data = d, formula = total.biomass ~ Shannon * Ninitial)

summary(model)

t <- ggpredict(model, c("Shannon", "Ninitial"))

ggplot(t, 
       aes(x = x,
           y = predicted,
           color = group)) +
    geom_line() +
    labs(x = "Shannon",
         y = "Predicted total biomass",
         color = "Ninitial") +
    theme_bw()

```

# Three-way interaction

Now a three way interaction between Shannon, Stage, and Ninitial. This now incorporates both
phases of the experiment.

```{r three-way-linear-model, echo=T, message=FALSE}

d <- adam

model <- lm(data = d, formula = total.biomass ~ Shannon * Stage * Ninitial)

summary(model)

t <- ggpredict(model, c("Shannon", "Ninitial", "Stage"))

ggplot(t) +
    geom_line(aes(x = x,
                  y = predicted,
                  color = group)) +
    facet_grid(. ~ facet) +
    labs(x = "Shannon",
         y = "Predicted total biomass",
         color = "Ninitial") +
    theme_bw()

```

This interaction plot incorporates both Ninitial and Stage. To try to see if I could get the "mainEffect" 
plot out of our more complicated model, I now try to use the same predict function except excluding
Ninitial as a variable to predict.

```{r three-way-linear-model-continued, echo=T, message=F}

t <- ggpredict(model, c("Shannon", "Stage"))

ggplot(t) +
    geom_line(aes(x = x,
                  y = predicted,
                  color = group)) +
    labs(x = "Shannon",
         y = "Predicted total biomass",
         color = "Stage") +
    theme_bw()

```

I think that this shows that we do have to use two models, one with Ninitial as an explanatory variable,
and one without Ninitial as an explanatory variable. Without two models, we can't see that the general
trend is a positive relationship between diversity and biomass, but within richness treatments it's negative.

# Linear mixed-effect model

I wish that I had done this stepwise initially, because this was a very enlightening experience.
In reality, our random effect doesn't really do anything! Below, I make a linear-mixed effects model
with the random effect `(Ninitial|Stage)`.

```{r most-complex-linear-model, echo=TRUE, message=FALSE}

d <- adam

model <- lmer(data = d, formula = total.biomass ~ Shannon * Ninitial * Stage + (Ninitial|Stage))

summary(model)

t <- ggpredict(model, c("Shannon", "Ninitial", "Stage"))

ggplot(t) +
    geom_line(aes(x = x,
                  y = predicted,
                  color = group)) +
    facet_grid(~ facet) +
    labs(x = "Shannon",
         y = "Predicted total biomass",
         color = "Stage") +
    theme_bw()

```

With the random effect incorporated, the effects plots are left unchanged from the more simple model,
`total.biomass ~ Shannon * Ninitial * Stage`.

# Nadja's model

You wanted me to test `total.biomass ~ Shannon * Stage + Ninitial + Ninitial:Stage`

```{r Nadja-model, echo=TRUE, message=FALSE}

d <- adam

model <- lm(data = d, formula = total.biomass ~ Shannon * Stage + Ninitial + Ninitial:Stage)

summary(model)

t <- ggpredict(model, c("Shannon", "Ninitial", "Stage"))

ggplot(t) +
    geom_line(aes(x = x,
                  y = predicted,
                  color = group)) +
    facet_grid(~ facet) +
    labs(x = "Shannon",
         y = "Predicted total biomass",
         color = "Stage") +
    theme_bw()

```

I don't really understand this formula. When we meet, could you explain the following to me:

"Ninitial:Stage" represents an interaction, but not a term. Does this mean that our model has:

* Shannon
* The interaction between Shannon and Stage
* Stage
* Ninitial
* The interaction between Stage and Ninitial
* *But importantly, __NOT__ the interaction between Shannon and Ninitial*?

If so, why did you think that we shouldn't have an interaction between Shannon and Ninitial?

# Departing question

Shannon diversity and Ninitial are correlated. Is this a problem?
